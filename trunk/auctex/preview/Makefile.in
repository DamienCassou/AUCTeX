
@SET_MAKE@
LATEX=@LATEX@
TEX=@TEX@
TEXHASH=@TEXHASH@

EMACS=@EMACS@
ICONFORM=@ICONFORM@
ELCC=$(EMACS) -batch -q -no-site-file -no-init-file --eval '(setq load-path (cons "." load-path))' $(ICONFORM)
AUCTEX=-eval '(if (not (string-equal "$(AUCTEXDIR)" "")) \
                (setq load-path (cons "$(AUCTEXDIR)" load-path)))'

LISP_SOURCES := @PLAT_LISP@ preview.el
LISP_OBJS := $(LISP_SOURCES:.el=.elc)

ICON_XPM_SOURCES := images/prevwork.xpm images/preview.xpm
ICON_XBM_SOURCES := ${ICON_XPM_SOURCES:.xpm=.xbm}
ICON_SOURCES := $(ICON_XPM_SOURCES) $(ICON_XBM_SOURCES)

prefix = @prefix@
lispdir = @lispdir@
icondir = @icondir@
datadir = @datadir@
texmfdir = @texmfdir@
previewtexmfdir = @previewtexmfdir@
previewdocdir = @previewdocdir@
packagedir = @packagedir@
AUCTEXDIR = @AUCTEXDIR@
TEXMFGEN = @TEXMFGEN@

INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
MKINSTALLDIRS = ./mkinstalldirs

all: texmf elisp docs install-hint

elisp: $(LISP_OBJS)

texmf: $(TEXMFGEN) preview.drv preview-mk.ins preview.dvi

docs:
	(cd doc ; $(MAKE) all)

install-hint:
	@echo "Congratulations!  Build is complete."
	@echo 
	@echo "Now, run \"make install\" as root, or whatever user has permissions"
	@echo "to write to the install directory."

install: install-texmf install-el install-icons install-docs use-hint

install-docs:
	(cd doc ; $(MAKE) install)

use-hint:
	@echo "Installation completed."
	@echo
	@echo "Please read the PROBLEMS file if you use"
	@echo "a) AucTeX with a version less than 11.0"
	@echo "b) GNU Emacs with a version less than 21.2"
	@echo "c) GhostScript with a version less than 6.51"
	@echo "Please use M-x preview-report-bug if you experience any"
	@echo "problems not mentioned in there."

install-el: $(LISP_OBJS)
	-$(MKINSTALLDIRS) $(lispdir)
	for x in $(LISP_SOURCES) ; do \
	  echo " $(INSTALL_DATA) $$x $(lispdir)" ; \
	  $(INSTALL_DATA) $$x $(lispdir) ; \
	  echo " $(INSTALL_DATA) $${x}c $(lispdir)" ; \
	  $(INSTALL_DATA) $${x}c $(lispdir) ; \
	done; \
	$(ELCC) -l prv-install -f preview-make-package $(packagedir) $(LISP_SOURCES); \

install-icons: $(ICON_SOURCES)
	-$(MKINSTALLDIRS) $(icondir)
	for x in $(ICON_SOURCES); do \
	  echo " $(INSTALL_DATA) $$x $(icondir)" ; \
	  $(INSTALL_DATA) $$x $(icondir) ; \
	done

install-texmf: $(TEXMFGEN) install-texmf-doc
	-$(MKINSTALLDIRS) $(previewtexmfdir)
	for x in $(TEXMFGEN) ; do \
	  echo " $(INSTALL_DATA) $$x $(previewtexmfdir)" ; \
	  $(INSTALL_DATA) $$x $(previewtexmfdir) ; \
	done
	-$(TEXHASH) $(texmfdir)

install-texmf-doc: preview.dvi
	-$(MKINSTALLDIRS) $(previewdocdir)
	$(INSTALL_DATA) preview.dvi $(previewdocdir)

preview-mk.ins: preview.dtx bootstrap.ins
	$(TEX) '\nonstopmode \input bootstrap.ins'

#only for standalone preview.sty package:
preview.ins: preview.dtx
	$(TEX) '\nonstopmode\def\jobname{.ins}\input docstrip ' \
	'\generate{\file{preview.ins}{\from{preview.dtx}{installer}}}' \
	'\endbatchfile'

$(TEXMFGEN) preview.drv: preview.dtx preview-mk.ins
	$(TEX) '\nonstopmode \input preview-mk.ins'

preview.dvi: preview.drv preview.dtx
	$(LATEX) '\nonstopmode \input preview.drv'
	$(LATEX) '\nonstopmode \input preview.drv'
	$(LATEX) '\nonstopmode \input preview.drv'

$(LISP_OBJS):	$(LISP_SOURCES)
	for x in $(LISP_SOURCES) ; do \
	  echo "$(ELCC) $(AUCTEX) -f batch-byte-compile $$x" ; \
	  $(ELCC) $(AUCTEX) -f batch-byte-compile $$x ; \
	done

clean:
	rm -f *.elc *~ *.aux *.dvi *.drv
	rm -f docstrip.log preview.ins preview.log preview.drv preview.sty \
		prauctex.def prauctex.cfg preview.aux preview.dvi circ.log \
		circ.dvi circ.aux texput.log testdocstrip.tex \
		testdocstrip.log bootstrap.log preview-mk.ins preview-mk.log
	(cd doc ; $(MAKE) clean)

distclean:
	make clean
	rm -f config.log config.cache config.status
	rm -f Makefile
